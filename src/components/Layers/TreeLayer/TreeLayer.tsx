import { useEffect, useRef } from "react";
import { useMapContext } from '../../../context/MapContext';
import { Threebox } from 'threebox-plugin';

type Props = {
  map: mapboxgl.Map
  modelReady: boolean
}

const TreeLayer = ({map, modelReady} : Props) => {
    
    const initializedRef = useRef<boolean | false>(false);
    const treeModelRef = useRef<any | null>(null);

    const { setIsLoading, setTreeModelReady } = useMapContext();

    useEffect(() => {
      if (!map || initializedRef.current) return;
      // The map object has been passed and is ready for use in the Car Layer component
      initializedRef.current = true;
      initializeLayer();
      
      
      return () => {
        if (map && map.isStyleLoaded() && window.tb) {
          window.tb.clear();

          map.off('moveend', updateModels);
          map.off('zoomend', updateModels); 
          
          if (window.tb1) {
            window.tb1.clear();
            map.triggerRepaint();
          }
        
          if (map.getLayer("tree-model-lyr")) {
            map.removeLayer("tree-model-lyr");
          }            
        }
      };

    }, []);

    useEffect(() => {
      if(modelReady !== true) { return }
      console.log("Tree model has been loaded!")
    }, [modelReady]);    

    const initializeLayer = () => {
      
      setIsLoading(true);

      map.addLayer({
        id: "tree-model-lyr",
        type: "custom",
        renderingMode: "3d",
        onAdd: function () {
          
          if(!window.tb1) {
            window.tb1 = new Threebox(map, map.getCanvas().getContext('webgl'), { defaultLights: true });
          }
      
          const options = {
            obj: import.meta.env.VITE_TREE_MODEL_URL,
            type: "glb",
            scale: 4,
            rotation: { x: 90, y: 0, z: 0 },
            adjustment: {x: 0.5, y: 0.5, z: 0},
            units: 'meters'
          };
      
          window.tb1.loadObj(options, (model) => {
            model.userData.carModel = true;
            treeModelRef.current = model;
      
            setTreeModelReady(true);

            // place models for currently visible points
            //const features = map.queryRenderedFeatures({ layers: ['ACTIVE_LOTS'] });
            //const points = features.map(f => ({ lng: f.geometry.coordinates[0], lat: f.geometry.coordinates[1] }));
            updateModels();
          });
        },
        render: function () {
          window.tb1.update();
        }
      });        
    
      map.on('moveend', updateModels);
      map.on('zoomend', updateModels); 

      
      updateModels();
      
    }
    const displayModels = (positions) => {
      if (!treeModelRef.current || treeModelRef.current === null) return;
    
      window.tb1.clear();

      map.triggerRepaint();

      positions.forEach((pos) => {
        const clone = treeModelRef.current.duplicate();
        const worldPos = window.tb1.projectToWorld([pos[0], pos[1], 0])
        clone.position.set(worldPos.x, worldPos.y, worldPos.z);
        clone.scale.set(0.025, 0.025, 0.025);
        clone.rotation.set(0, 0, -117 * (Math.PI / 180));
        window.tb1.add(clone);          
      });
      setIsLoading(false);
    };
    const updateModels = () => {
      const points = [

        [23.318452439457502, 42.68655923685955],
        [23.318391970089067, 42.68601911272617],
        [23.318374680634918, 42.686345312961635],
        [23.318631140882047, 42.68666939331686],
        [23.318622496154944, 42.68645757628278],
        [23.31892218004026, 42.68657407574079],
        [23.318593680397015, 42.68694687253921],
        [23.31864091981231, 42.687234888129694],
        [23.318793643330224, 42.68708873578336],
        [23.31870143290476, 42.6874149304021],
        [23.318797192468367, 42.68775214696572],
        [23.318756850408136, 42.68762082277877],
        [23.318898047622355, 42.687538215486484],
        [23.318941271260627, 42.6873518191411],
        [23.31884329823481, 42.687911006274845],
        [23.31902195593537, 42.6878749981494],
        [23.318961442842976, 42.688088928469256],
        [23.318527167686852, 42.68679102685431],
        [23.318616010365446, 42.68711564740647],
        [23.318940413655724, 42.68770518575647],
        [23.318776742463626, 42.686977516161704],
        [23.318743529319676, 42.686589908664104],
        [23.318563941261942, 42.68634793577169],
        [23.31994591703122, 42.68663318323101],
        [23.320110545790214, 42.68670531633532],
        [23.31998676940401, 42.68678390850613],
        [23.32025789730045, 42.68674991061974],
        [23.320108309457368, 42.68685834315036],
        [23.319996309877837, 42.687048018108015],
        [23.32020125551111, 42.686964831638306],
        [23.320402985337864, 42.686873240674885],
        [23.320523702231753, 42.68679453662418],
        [23.319954054705022, 42.686463785099846],
        [23.320057493225164, 42.68641094203184],
        [23.319956696047427, 42.68638559320158],
        [23.320163829943453, 42.686381369394525],
        [23.320054300842713, 42.686328595864296],
        [23.319962183403078, 42.686299062129706],
        [23.319637270813956, 42.686254787674415],
        [23.319634496805293, 42.68647224413289],
        [23.3196604980144, 42.68660562484675],
        [23.32012525552784, 42.68708860917931],
        [23.31988333664765, 42.687184115951425],
        [23.319950133094295, 42.68731594166124],
        [23.319933246455093, 42.687456576992815],
        [23.320001887050296, 42.68725212045473],
        [23.32002188158461, 42.68719686118311],
        [23.319594629323547, 42.68803770969666],
        [23.319554152253204, 42.68795671390927],
        [23.31979912196897, 42.6876274144922],
        [23.31964034915282, 42.68722610431723],
        [23.320404953940624, 42.68741951015332],
        [23.320428675836837, 42.68755965956376],
        [23.320493007851354, 42.687719301053676],
        [23.320429940202388, 42.687830224402205],
        [23.320397544085637, 42.687700122637466],
        [23.320347722671784, 42.687527779920146],
        [23.320159432900027, 42.68724793575501],
        [23.31779415047569, 42.68692952424135],
        [23.317640091767913, 42.68704368762698],
        [23.317559200689118, 42.6872175444403],
        [23.31762999359057, 42.68715748591441],
        [23.317726971180377, 42.68794643866573],
        [23.31790814190404, 42.687926035069125],
        [23.318069972235918, 42.68788336442819],
        [23.318023161895695, 42.68779584503764],
        [23.31780902472056, 42.68784352713462],
        [23.317613144835633, 42.687872551143755],
        [23.3175980605931, 42.686378194486736],
        [23.317679577237328, 42.68631804020495],
        [23.31759694793439, 42.68628511351449],
        [23.317531492817153, 42.68619260206876],
        [23.317498646220713, 42.68610131792275],
        [23.31764060857148, 42.68620558448575],
        [23.31722956787516, 42.686345676278364],
        [23.31711988566866, 42.686323298854376],
        [23.316994767498727, 42.68656729133997],
        [23.317132109557974, 42.686439933099166],
        [23.316831169386518, 42.68635102292305],
        [23.316763865501684, 42.68629673463482],
        [23.317164719706142, 42.686113977823],
        [23.31641531368021, 42.687002391636526],
        [23.31613553148452, 42.6871725514342],
        [23.31588475056938, 42.68724966784694],
        [23.315988061692764, 42.68736155201924],
        [23.315863004264514, 42.68738267189133],
        [23.315797012250272, 42.687332921229],
        [23.31631456555928, 42.6871224505968],
        [23.316127809664152, 42.68707892371853],
        [23.31616879675431, 42.687012458015914],
        [23.31631741849185, 42.68614972777806],
        [23.316453598088685, 42.68595142335835],
        [23.31633487125029, 42.68603161732557],
        [23.31643930597039, 42.68603584758398],
        [23.31672437614654, 42.685735248940375],
        [23.3177193774641, 42.68557579345645],
        [23.317858884701167, 42.68552817532526],
        [23.317783950854192, 42.68547885320538],
        [23.31775277928068, 42.68537105215418],
        [23.31757026320909, 42.68533619207088],
        [23.317623396791873, 42.68547577150861],
        [23.317498472370886, 42.68544130222253],
        [23.317413339816596, 42.68536775297977]        

      ];
      displayModels(points);      
    }
    

    return null;
}
export default TreeLayer;